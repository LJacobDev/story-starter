# Copilot Working Memory Reference

## Current Project State
- **Last Known Good State**: StoryDetails share implemented; prior suites green before adding image tests.
- **Currently Working**: Phase 3.2.1i/j — Fix image spec interactions (radio selection + file input) so tests pass; then finalize implementation.
- **Last Test Results**: Targeted run requested for StoryDetails.image.spec.ts; awaiting fresh results after radio interaction fix.
- **Known Issues**:
  - Real toasts not yet integrated (placeholders only); plan to add shadcn toast after 3.2.1l.
  - Image pipeline implementation pending (useStoryImage validations + integration in StoryDetails edit form).

## Key File Relationships
- `src/views/StoryDetails.vue` uses: `useStory.getById`, `useStory.update`, `useStory.remove`, `vue-router` (watches `route.params.id`), and `useAuth` for `isOwner` (compares `user.id` to `story.user_id`).
- `src/composables/useStory.ts` depends on: `utils/supabase` client; table `story_starter_stories` with RLS.
- `src/views/Home.vue` uses: `useStories.fetchPublic/fetchMine`. Note: when tests navigate Home, these calls can run; unit tests that redirect to Home should stub the view to avoid external fetches.
- `src/App.vue` includes a no-router fallback handling `/demo` for unit tests.

## Recent Changes Made
- [2025-09-19]: Tests — Updated `tests/unit/StoryDetails.image.spec.ts` to use `setValue(true)` for radio inputs and kept the corrected file input change pattern (assign files property, then trigger change).
- [2025-09-19]: Tests — Added `tests/unit/StoryDetails.share.spec.ts` covering Share button visibility, navigator.share usage, clipboard fallback, and private-story warning (expected failing tests initially; now passing with implementation).
- [2025-09-18]: StoryDetails — Added owner-only Edit with form (title, story_type, genre, description, image_url, is_private, content), validation caps (title ≤120, genre ≤60), Cancel/Save with pending; wired to `useStory.update`.
- [2025-09-18]: StoryDetails — Added Delete with confirm dialog and pending; on confirm calls `useStory.remove` then navigates to Home.
- [2025-09-18]: Tests — Added `tests/unit/StoryDetails.edit.spec.ts` and `tests/unit/StoryDetails.delete.spec.ts`; delete spec stubs Home to prevent Supabase fetch side-effects; both suites passing.
- [2025-09-18]: Composables — Implemented `useStory.update(id, patch)` and `useStory.remove(id)` with error mapping.
- [2025-09-18]: App — Updated no-router fallback in `App.vue` to handle `/demo`, restoring passing demo/logo test.
- [2025-09-19]: Tests — Added `tests/unit/StoryDetails.image.spec.ts` covering URL mode validation/preview/remove and upload mode via composable returning signed URL.
- [2025-09-19]: Composables — Added stub `src/composables/useStoryImage.ts` with `upload(file)` placeholder (tests mock behavior).
- [2025-09-19]: Views — Implemented Share in `StoryDetails.vue` with navigator.share/clipboard fallback and private warning.

## Next Steps Plan
1. Run the targeted image suite to confirm the radio fix: StoryDetails.image.spec.ts.
2. If radios still fail on this VTU version, switch to setting `input.element.checked = true` and `await input.trigger('change')` as an alternative.
3. Ensure upload mode test path continues to set `files` on the input element and trigger change without passing `target` payload.
4. Re-run the full StoryDetails suites (edit/delete/share/image) to guard against regressions.

## Verification Plan
- Automated: run the targeted suite for image handling; then full StoryDetails suites.
- Success criteria: All StoryDetails specs pass; no TypeScript errors in tests; preview/remove behaviors verified via data-testid hooks.
- Rollback: Revert the latest test changes if failures persist; fall back to the explicit `checked` assignment approach for radios.

## Human-parsable summary
- Adjusted image tests to use VTU-supported radio interaction (`setValue(true)`), retained correct file input event pattern. Next, run the suite and, if necessary, switch to explicit `checked` assignment for stability on this VTU version.

Update timestamp: 2025-09-19.



## Context Section about Phase 4 Planning (Generated by another model in ask mode — agents, don’t directly edit this section but be aware of it)

Purpose
- Deliver LLM-based story generation via a minimal Supabase Edge Function proxy (“gemini-proxy”) that only sanitizes inputs/outputs and enforces basic limits/rate‑limits. All prompt engineering and output parsing happen on the frontend.
- Phase 4 is the MVP for generation; Phase 6 adds advanced controls (seed lock, custom types, richer undo, metadata persistence).

User journey
- User clicks “Generate New Story.”
- A form collects structured prompts:
  - Story type: short-story | movie-summary | tv-commercial. Internally stored as hyphen‑slugs; UI displays labels with spaces (“Short story,” “Movie summary,” “TV commercial”).
  - Optional title, genre, tone, creativity.
  - Dynamic tags: themes, plot points.
  - Dynamic characters: name, role (protagonist/antagonist/ally/other), optional description.
  - Free‑text “additional instructions” (warn if > 800 chars; allow up to 2000).
  - Optional image (upload to Supabase Storage or paste URL).
  - Privacy toggle (default private; user can opt‑in to public).
- Submit:
  - Frontend constructs the full model prompt string (prompt engineering lives entirely in the client).
  - Frontend instructs Gemini to return strict JSON (via prompt content).
  - Frontend POSTs that final prompt string to the gemini‑proxy Edge Function.
- Edge Function behavior:
  - Validates request size and rate limits.
  - Sanitizes the incoming prompt (trim/collapse whitespace, strip obvious HTML/scripts/control characters).
  - Forwards the sanitized prompt to Gemini as‑is (no server-side templating or schema instructions).
  - Receives Gemini text, sanitizes it (remove BOM, dangerous tags, normalize whitespace; optionally pass through code‑fences untouched).
  - Returns sanitized text to the frontend without parsing or reformatting.
- Frontend then:
  - Cleans fences/backticks if needed, extracts JSON, validates against the client schema, and shows a preview.
  - From preview: Save (persist), Retry (fresh sample) with Undo to restore previous preview, Edit prompts (return to form), or Discard (no persistence).
  - Drafts remain in memory only until Save (no “draft” rows in DB for Phase 4).

Data conventions and limits
- Story types: hyphen slugs in DB/APIs; space‑separated labels in UI.
- Images:
  - Allowed types: png, jpeg, webp.
  - Max size: 2 MB.
  - Dimensions: min 200×200, max 4000×4000; any aspect ratio.
  - Stored in bucket story-covers with owner‑only RLS; display via signed URLs.
  - If none, show type‑specific monochrome SVG fallback (decorative, aria‑hidden):
    - Short story → open book (slate/gray).
    - Movie summary → filmstrip (indigo/blue).
    - TV commercial → clapperboard or megaphone (emerald/green).
- Input validation (client) and guidance:
  - Title ≤ 120; Genre ≤ 60; Tone ≤ 60.
  - Themes ≤ 10, each ≤ 30.
  - Plot points ≤ 10, each ≤ 200.
  - Characters ≤ 6; name ≤ 60; description ≤ 400; role is enum.
  - Additional instructions ≤ 2000; warn when > 800 (latency hint).
- Server safeguards (edge):
  - Enforce reasonable total input budget (~6000 chars) and moderate rate limits.
  - Return sanitized model text; do not attempt JSON parsing.

Privacy and access control
- Default is_private = true on the form; Save preserves user choice.
- RLS: anon can read public; authenticated can read public + own; writes are owner‑only with WITH CHECK.

Retry/Undo semantics
- Retry always requests a fresh sample (no deterministic seed in Phase 4).
- When a retry completes, the preview is replaced; Undo restores the prior preview (single‑level undo).
- Phase 6 will add a visible “Lock seed” toggle for deterministic generations, and deeper undo for text fields.

Responsibilities split
- Frontend:
  - Prompt builder: composes final model prompt, includes strict “respond only with JSON” instructions and the JSON schema description.
  - Calls gemini‑proxy with the prompt string.
  - Extracts and parses JSON from the sanitized text; validates schema; handles user‑visible errors.
  - Image validation/upload, preview, save flow, idempotency on Save, toasts.
- Edge function:
  - Safety and hygiene only: input/output sanitization, size caps, moderate per‑user rate limits (e.g., default: ~8/min, 60/hour, 200/day — adjustable via env).
  - Transparent pass‑through to Gemini; no server‑side templating or response shaping beyond sanitization.
  - Clear error taxonomy: 400 validation, 429 rate limit with Retry‑After, 5xx transient.

Out of scope for Phase 4 (defer to Phase 6+)
- Custom story types authored by users.
- Persisting generation request metadata (prompts/settings) in DB.
- Deterministic seed controls (add visible “Lock seed” toggle later).
- Multi‑level undo for form editors.
- AI image generation.

Quality gates for Phase 4
- TDD for form behavior, prompt builder, client parsing, preview/save/undo, image pipeline, and edge function contract (sanitization + rate limit).
- Manual checklist includes privacy default, length caps/warnings, upload constraints, retry→undo, 429 handling UX, and basic a11y.

Key risks and mitigations
- Non‑JSON model replies → robust client extraction and schema validation; friendly parse errors.
- Latency → input caps and 800‑char warning; visible progress; no server templating to keep flow simple.
- Duplicate saves → client idempotency key; disable Save while pending.
- Storage misuse → client/type/size/dimension checks + bucket RLS; signed URLs only.

Here’s the append-only update block for the Phase 4 section.

## Phase 4 Addendum — New Decisions and Execution Details (since last update)

- Model default: gemini-2.5-flash.
- Edge function request shape confirmed: POST { prompt: string } only; proxy sanitizes input/output and forwards as-is; frontend owns prompt engineering and JSON parsing.
- Rate-limit/env knobs finalized: RL_BURST, RL_PER_HOUR, RL_PER_DAY, MAX_PROMPT_CHARS (~6000). Moderate defaults; adjustable via env.
- Storage confirmed: bucket story-covers; path userId/storyId/filename; owner-only RLS; signed-URL viewing.
- Test strategy (TDD) options:
  - Option A (parallel-safe): place Phase 4 specs under tests/phase4 and gate them so CI/Phase 3 aren’t affected. Local run:
    ````bash
    RUN_PHASE4=1 vitest --include "tests/phase4/**/*.spec.ts" --watch
    ````
    Gate each spec:
    ````ts
    const RUN_PHASE4 = process.env.RUN_PHASE4 === '1';
    (RUN_PHASE4 ? describe : describe.skip)('Phase 4 — <suite>', () => { /* … */ });
    ````
  - Option B (single-stream): when Phase 3 wraps or if the same agent continues, place tests in the normal locations immediately (tests/unit, tests/integration, tests/edge) without gating.
- Branching to avoid collisions with Phase 3: work on a phase4-prep branch; separate VS Code window optional. Do not touch:
  - src/components/stories/*, src/views/Home.vue, src/composables/useStories.ts, or existing Phase 3 tests.
- Safe, additive deliverables to start now (unreferenced by Phase 3):
  - docs/phase4/: gemini-proxy contract + runbook, image pipeline guide, prompt-builder notes, a11y/UX checklist.
  - supabase/functions/gemini-proxy/: sanitize-and-forward scaffold with env-driven limits (not wired to UI).
  - src/utils/: extractJson, slugify/humanize story type, imageValidation, idempotencyKey (+ gated tests).
  - src/types/generation.ts; src/composables/useGeneration.ts (stub; not imported yet).
- Execution note: test gating is optional. If the current Phase 3 agent proceeds to Phase 4 next, use Option B and place tests in the standard folders.


## Phase 4 Addendum — Optional “Revise with AI” for Existing Stories (post‑Phase‑4)

Summary
- Feature: add a “Revise with AI” action available on any story the current user owns.
- Flow:
  1. Owner clicks “Revise with AI”.

